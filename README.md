
# DDBOT 更新日志  
> 版本：2025-06-27  
> 作者：Yar1991-Translation
> 说明：本次更新聚焦于 **日期/节日播报系统** 的引入与指令体系完善，同时伴随若干底层优化与错误修复。以下内容未包含任何私人/生日具体信息，仅呈现通用能力与实现细节。

---

## ✨ 主要新功能

### 1. 日期播报系统
| 功能 | 说明 |
| ---- | ---- |
| **定时自动播报** | 内置 `cron` 规则 `0 0,6,12,14,18,20 * * *`，每日 6 个时间点向所有订阅群发送「今日日期 + 问候语」的推送。 |
| **私聊指令 `/day`** | 管理员私聊触发，立即向订阅群播报当日日期，支持临时手动播报或调试。 |
| **多时段问候语** | 通过 `hourGreetings` 映射为常规 0/6/12/14/18/20 点提供默认问候，可自行增删。 |
| **节日/纪念日祝福** | `specialDateText` 支持对 `MM-DD` 日期级别配置整日祝福。 |
| **分时段节日祝福** | `specialDateHourlyText` 支持对指定日期按小时粒度配置定制化祝福文本，拥有更高优先级。 |

### 2. 指令体系扩展
- `DayCommand`  
  - 常量定义与 `CommandMaps` 注册。  
  - 加入私聊指令解析列表与帮助模版。  
  - 执行流程：权限校验 → 生成日期消息 → 广播 → 反馈成功数。

### 3. 代码结构
- **`lsp/day_broadcast.go`**  
  - 新文件，封装日期消息构造、问候/节日映射、广播逻辑、定时任务注册。  
  - 提供易读的注释与映射示例，方便二次配置。
- **`lsp/module.go`**  
  - `PostStart` 阶段新增 `l.scheduleDayBroadcast()` 调用，保证任务随服务启动加载。  
  - `Cron` 表达式更新，统一管理所有定时任务。

---

## 🛠 其他改进

1. **通用问候映射**  
   - `hourGreetings` 默认提供 6 条时段问候，覆盖早晚及用餐提示。  
   - 新增 `20` 点问候，丰富夜间场景。

2. **模板与日志**  
   - 模板调用失败时输出明确错误信息，便于排查。  
   - 新增 `template_name` 字段便于追踪渲染来源。

3. **权限与安全**  
   - `/day` 指令仅限管理员（`AdminRole`）执行，避免普通用户滥用广播功能。  
   - 广播目标默认取订阅群集合，后续可根据业务需求接入「群订阅白名单」过滤器。

---

## 🐞 Bug 修复

| 问题 | 处理 |
| ---- | ---- |
| 编译失败：字符串未正确转义 | 将含引号文案改为 **原始字符串字面量** (`\`\`) 解决。 |
| Cron 重复定义 | 去除冗余 `scheduleDayBroadcast` 栈底实现，保持单点注册。 |
| 可能的 nil 元素发送 | 对消息元素做过滤，避免空指针导致 panic。 |

---

## 💡 升级指南

1. **拉取/合并** 新代码后，检查 `lsp/day_broadcast.go`：
   - 如需自定义节日，追加或修改 `specialDateText`/`specialDateHourlyText`。
   - 如需修改定时点，调整 `cron.AddFunc(...)` 中的表达式。
2. **编译 & 部署**  
   ```bash
   go build -o ddbot
   ./ddbot
   ```
3. **管理员验证**  
   - 私聊 BOT 发送 `/day`，观察是否向目标群发送日期播报。  
   - 留意控制台/日志输出，确认定时任务已启动。  
   - 如需禁用，暂时可注释 `scheduleDayBroadcast` 调用或清空 Cron 映射。

---

## 📌 备注

- 本功能为通用节日/日期提醒框架，不包含任何硬编码的私人信息。  
- 所有文案均可在源码中便捷修改，支持动态配置。  
- 欢迎为更多节日补充祝福文本或 PR 提交改进！  
